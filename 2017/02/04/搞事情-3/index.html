<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 搞事情-3 · Bonjour!</title><meta name="description" content="搞事情-3 - BonjourChen"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Bonjour!"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/webinchen" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/bonjourchen" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">搞事情-3</h1><div class="post-info">Feb 4, 2017</div><div class="post-content"><p>在打算做数据处理的时候，发现好像数据不太对？发现算出来的均值数据和证券软件上的差别有点大，于是就回到代码检查原因。后来发现<code>get_hist_data()</code>函数获取的数据是后复权的。于是换成了<code>get_k_data()</code>。<br><a id="more"></a><br><code>get_k_data()</code>的返回结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">In [68]: df2 = ts.get_k_data(&apos;002729&apos;, start=&apos;2016-10-01&apos;)</div><div class="line"></div><div class="line">In [69]: df2</div><div class="line">Out[69]:</div><div class="line">           date   open  close   high    low   volume    code</div><div class="line">184  2016-10-10  74.88  76.50  77.18  74.01   9173.0  002729</div><div class="line">185  2016-10-11  76.37  76.61  77.45  75.75   5544.0  002729</div><div class="line">186  2016-10-12  77.08  78.10  78.91  75.32   7890.0  002729</div><div class="line">187  2016-10-13  77.90  77.80  78.50  77.20   4387.0  002729</div><div class="line">188  2016-10-14  76.98  78.00  78.22  76.98   5120.0  002729</div><div class="line">189  2016-10-17  78.00  78.00  78.85  77.30   4789.0  002729</div><div class="line">190  2016-10-18  78.00  78.30  78.59  77.51   3522.0  002729</div></pre></td></tr></table></figure></p>
<p>所以所以均值都要自己计算。<br>主要修改的代码部分如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 建立股票信息表</span></div><div class="line">session.execute(<span class="string">'DROP TABLE IF EXISTS `stock_data`;'</span>)</div><div class="line">session.execute(<span class="string">'''</span></div><div class="line">  CREATE TABLE `stock_data` (</div><div class="line">  `date` text,</div><div class="line">  `code` text,</div><div class="line">  `open` double DEFAULT NULL,</div><div class="line">  `high` double DEFAULT NULL,</div><div class="line">  `close` double DEFAULT NULL,</div><div class="line">  `low` double DEFAULT NULL,</div><div class="line">  `volume` double DEFAULT NULL,</div><div class="line">  `p_change` double DEFAULT NULL,</div><div class="line">  `ma5` double DEFAULT NULL,</div><div class="line">  `ma10` double DEFAULT NULL,</div><div class="line">  `ma20` double DEFAULT NULL,</div><div class="line">  `ma30` double DEFAULT NULL,</div><div class="line">  `ma60` double DEFAULT NULL,</div><div class="line">  `ma250` double DEFAULT NULL,</div><div class="line">  KEY `ix_d_data_date` (`date`(20))</div><div class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</div><div class="line">''')</div><div class="line">session.execute(<span class="string">'truncate table stock_data;'</span>)</div><div class="line"></div><div class="line"><span class="comment">#修改均值计算函数</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_stock_basics_2</span><span class="params">(code)</span>:</span></div><div class="line">    df_stock_tmp = ts.get_k_data(code, start=<span class="string">'2016-01-01'</span>)</div><div class="line">    <span class="keyword">if</span> df_stock_tmp <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">        df_stock_tmp = df_stock_tmp.set_index(<span class="string">'date'</span>)</div><div class="line">        df_stock_tmp_len = len(df_stock_tmp.index)</div><div class="line">        <span class="comment"># 计算ma5的值，保留三位小数</span></div><div class="line">        <span class="keyword">if</span> df_stock_tmp_len &gt; <span class="number">5</span>:</div><div class="line">            ma5 = talib.MA(df_stock_tmp.close.values, <span class="number">5</span>)</div><div class="line">            ma5 = np.round(ma5, <span class="number">3</span>)</div><div class="line">            df_stock_tmp[<span class="string">'ma5'</span>] = ma5</div><div class="line">        <span class="comment"># 计算ma10的值，保留三位小数</span></div><div class="line">        <span class="keyword">if</span> df_stock_tmp_len &gt; <span class="number">10</span>:</div><div class="line">            ma10 = talib.MA(df_stock_tmp.close.values, <span class="number">10</span>)</div><div class="line">            ma10 = np.round(ma10, <span class="number">3</span>)</div><div class="line">            df_stock_tmp[<span class="string">'ma10'</span>] = ma10</div><div class="line">        <span class="comment"># 计算ma20的值，保留三位小数</span></div><div class="line">        <span class="keyword">if</span> df_stock_tmp_len &gt; <span class="number">20</span>:</div><div class="line">            ma20 = talib.MA(df_stock_tmp.close.values, <span class="number">20</span>)</div><div class="line">            ma20 = np.round(ma20, <span class="number">3</span>)</div><div class="line">            df_stock_tmp[<span class="string">'ma20'</span>] = ma20</div><div class="line">        <span class="comment"># 计算ma30的值，保留三位小数</span></div><div class="line">        <span class="keyword">if</span> df_stock_tmp_len &gt; <span class="number">30</span>:</div><div class="line">            ma30 = talib.MA(df_stock_tmp.close.values, <span class="number">30</span>)</div><div class="line">            ma30 = np.round(ma30, <span class="number">3</span>)</div><div class="line">            df_stock_tmp[<span class="string">'ma30'</span>] = ma30</div><div class="line">        <span class="comment"># 计算ma60的值，保留三位小数</span></div><div class="line">        <span class="keyword">if</span> df_stock_tmp_len &gt; <span class="number">60</span>:</div><div class="line">            ma60 = talib.MA(df_stock_tmp.close.values, <span class="number">60</span>)</div><div class="line">            ma60 = np.round(ma60, <span class="number">3</span>)</div><div class="line">            df_stock_tmp[<span class="string">'ma60'</span>] = ma60</div><div class="line">        <span class="comment"># 计算ma250的值，保留三位小数</span></div><div class="line">        <span class="keyword">if</span> df_stock_tmp_len &gt; <span class="number">250</span>:</div><div class="line">            ma250 = talib.MA(df_stock_tmp.close.values, <span class="number">250</span>)</div><div class="line">            ma250 = np.round(ma250, <span class="number">3</span>)</div><div class="line">            df_stock_tmp[<span class="string">'ma250'</span>] = ma250</div><div class="line">        <span class="comment"># 计算涨跌幅</span></div><div class="line">        df_stock_tmp[<span class="string">'p_change'</span>] = np.round((df_stock_tmp[<span class="string">'close'</span>] - df_stock_tmp[<span class="string">'close'</span>].shift(<span class="number">1</span>)) / df_stock_tmp[<span class="string">'close'</span>].shift(<span class="number">1</span>), <span class="number">4</span>)</div><div class="line">        df_stock_tmp[<span class="string">'code'</span>] = code</div><div class="line">        print(<span class="string">'Collected data '</span> + code +</div><div class="line">              <span class="string">' COUNT:'</span> + str(len(df_stock_tmp.index)))</div><div class="line">        <span class="keyword">return</span> df_stock_tmp</div></pre></td></tr></table></figure></p>
<p>完整代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> tushare <span class="keyword">as</span> ts</div><div class="line"><span class="keyword">import</span> talib</div><div class="line"><span class="keyword">from</span> pandas <span class="keyword">import</span> DataFrame</div><div class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"></div><div class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</div><div class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</div><div class="line"></div><div class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</div><div class="line"><span class="keyword">import</span> threading</div><div class="line"><span class="keyword">import</span> time</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Get_stock_basics_Thread</span><span class="params">(threading.Thread)</span>:</span></div><div class="line">    <span class="string">"""docstring for Get_stock_basics_Thread"""</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, threadName, queue)</span>:</span></div><div class="line">        super(Get_stock_basics_Thread, self).__init__(name=threadName)</div><div class="line">        self.data = queue</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">global</span> myQueue</div><div class="line">        df_stock = pd.DataFrame()</div><div class="line">        print(self.name + <span class="string">' start at %s'</span> % time.ctime())</div><div class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                code = myQueue.get(block=<span class="keyword">False</span>)</div><div class="line">                <span class="keyword">if</span> code <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">                    <span class="keyword">break</span></div><div class="line">                df_stock_tmp = get_stock_basics_2(code)</div><div class="line">                <span class="keyword">if</span> df_stock.empty:</div><div class="line">                    df_stock = df_stock_tmp</div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    df_stock = [df_stock, df_stock_tmp]</div><div class="line">                    df_stock = pd.concat(df_stock)</div><div class="line">                <span class="keyword">if</span> len(df_stock.index) &gt; <span class="number">10000</span>:</div><div class="line">                    self.data.put(df_stock)</div><div class="line">                    df_stock = DataFrame()</div><div class="line">            <span class="keyword">except</span>:</div><div class="line">                print(self.name + <span class="string">' finish at %s'</span> % time.ctime())</div><div class="line">                self.data.put(df_stock)</div><div class="line">                <span class="keyword">break</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Write_to_MySQL</span><span class="params">(threading.Thread)</span>:</span></div><div class="line">    <span class="string">"""docstring for Write_to_MySQL"""</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, threadName, queue)</span>:</span></div><div class="line">        super(Write_to_MySQL, self).__init__(name=threadName)</div><div class="line">        self.data = queue</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        session, engine = connection()</div><div class="line">        print(self.name + <span class="string">' start at %s'</span> % time.ctime())</div><div class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                df_stock = self.data.get(timeout=<span class="number">100</span>)</div><div class="line">                print(<span class="string">'Import data to MySQL...'</span>)</div><div class="line">                df_stock.to_sql(<span class="string">'stock_data'</span>, engine, if_exists=<span class="string">'append'</span>)</div><div class="line">                print(<span class="string">'Import complete!'</span>)</div><div class="line">            <span class="keyword">except</span>:</div><div class="line">                print(self.name + <span class="string">' finish at %s'</span> % time.ctime())</div><div class="line">                <span class="keyword">break</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">connection</span><span class="params">()</span>:</span></div><div class="line">    <span class="comment"># 初始化数据库连接:</span></div><div class="line">    engine = create_engine(</div><div class="line">        <span class="string">'mysql+mysqlconnector://root:toor@localhost:3306/stock_test'</span>)</div><div class="line">    DB_Session = sessionmaker(bind=engine)</div><div class="line">    session = DB_Session()</div><div class="line">    <span class="keyword">return</span> session, engine</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_database</span><span class="params">(session)</span>:</span></div><div class="line">    <span class="comment"># 建立股票代码表</span></div><div class="line">    session.execute(<span class="string">'DROP TABLE IF EXISTS `stock_basics`;'</span>)</div><div class="line">    session.execute(<span class="string">'''</span></div><div class="line">      CREATE TABLE `stock_basics` (</div><div class="line">      `code` text,</div><div class="line">      `name` text,</div><div class="line">      KEY `ix_d_data_date` (`code`(20))</div><div class="line">    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;</div><div class="line">    ''')</div><div class="line">    session.execute(<span class="string">'truncate table stock_basics;'</span>)</div><div class="line"></div><div class="line">    <span class="comment"># 建立股票信息表</span></div><div class="line">    session.execute(<span class="string">'DROP TABLE IF EXISTS `stock_data`;'</span>)</div><div class="line">    session.execute(<span class="string">'''</span></div><div class="line">      CREATE TABLE `stock_data` (</div><div class="line">      `date` text,</div><div class="line">      `code` text,</div><div class="line">      `open` double DEFAULT NULL,</div><div class="line">      `high` double DEFAULT NULL,</div><div class="line">      `close` double DEFAULT NULL,</div><div class="line">      `low` double DEFAULT NULL,</div><div class="line">      `volume` double DEFAULT NULL,</div><div class="line">      `p_change` double DEFAULT NULL,</div><div class="line">      `ma5` double DEFAULT NULL,</div><div class="line">      `ma10` double DEFAULT NULL,</div><div class="line">      `ma20` double DEFAULT NULL,</div><div class="line">      `ma30` double DEFAULT NULL,</div><div class="line">      `ma60` double DEFAULT NULL,</div><div class="line">      `ma250` double DEFAULT NULL,</div><div class="line">      KEY `ix_d_data_date` (`date`(20))</div><div class="line">    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;</div><div class="line">    ''')</div><div class="line">    session.execute(<span class="string">'truncate table stock_data;'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_all_stock_name</span><span class="params">(session, engine)</span>:</span></div><div class="line">    <span class="comment"># 获取所有股票名字</span></div><div class="line">    stock_list_name = ts.get_stock_basics()[<span class="string">'name'</span>]</div><div class="line">    stock_list_name.to_sql(<span class="string">'stock_basics'</span>, engine, if_exists=<span class="string">'append'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_stock_basics_2</span><span class="params">(code)</span>:</span></div><div class="line">    df_stock_tmp = ts.get_k_data(code, start=<span class="string">'2016-01-01'</span>)</div><div class="line">    <span class="keyword">if</span> df_stock_tmp <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">        df_stock_tmp = df_stock_tmp.set_index(<span class="string">'date'</span>)</div><div class="line">        df_stock_tmp_len = len(df_stock_tmp.index)</div><div class="line">        <span class="comment"># 计算ma5的值，保留三位小数</span></div><div class="line">        <span class="keyword">if</span> df_stock_tmp_len &gt; <span class="number">5</span>:</div><div class="line">            ma5 = talib.MA(df_stock_tmp.close.values, <span class="number">5</span>)</div><div class="line">            ma5 = np.round(ma5, <span class="number">3</span>)</div><div class="line">            df_stock_tmp[<span class="string">'ma5'</span>] = ma5</div><div class="line">        <span class="comment"># 计算ma10的值，保留三位小数</span></div><div class="line">        <span class="keyword">if</span> df_stock_tmp_len &gt; <span class="number">10</span>:</div><div class="line">            ma10 = talib.MA(df_stock_tmp.close.values, <span class="number">10</span>)</div><div class="line">            ma10 = np.round(ma10, <span class="number">3</span>)</div><div class="line">            df_stock_tmp[<span class="string">'ma10'</span>] = ma10</div><div class="line">        <span class="comment"># 计算ma20的值，保留三位小数</span></div><div class="line">        <span class="keyword">if</span> df_stock_tmp_len &gt; <span class="number">20</span>:</div><div class="line">            ma20 = talib.MA(df_stock_tmp.close.values, <span class="number">20</span>)</div><div class="line">            ma20 = np.round(ma20, <span class="number">3</span>)</div><div class="line">            df_stock_tmp[<span class="string">'ma20'</span>] = ma20</div><div class="line">        <span class="comment"># 计算ma30的值，保留三位小数</span></div><div class="line">        <span class="keyword">if</span> df_stock_tmp_len &gt; <span class="number">30</span>:</div><div class="line">            ma30 = talib.MA(df_stock_tmp.close.values, <span class="number">30</span>)</div><div class="line">            ma30 = np.round(ma30, <span class="number">3</span>)</div><div class="line">            df_stock_tmp[<span class="string">'ma30'</span>] = ma30</div><div class="line">        <span class="comment"># 计算ma60的值，保留三位小数</span></div><div class="line">        <span class="keyword">if</span> df_stock_tmp_len &gt; <span class="number">60</span>:</div><div class="line">            ma60 = talib.MA(df_stock_tmp.close.values, <span class="number">60</span>)</div><div class="line">            ma60 = np.round(ma60, <span class="number">3</span>)</div><div class="line">            df_stock_tmp[<span class="string">'ma60'</span>] = ma60</div><div class="line">        <span class="comment"># 计算ma250的值，保留三位小数</span></div><div class="line">        <span class="keyword">if</span> df_stock_tmp_len &gt; <span class="number">250</span>:</div><div class="line">            ma250 = talib.MA(df_stock_tmp.close.values, <span class="number">250</span>)</div><div class="line">            ma250 = np.round(ma250, <span class="number">3</span>)</div><div class="line">            df_stock_tmp[<span class="string">'ma250'</span>] = ma250</div><div class="line">        <span class="comment"># 计算涨跌幅</span></div><div class="line">        df_stock_tmp[<span class="string">'p_change'</span>] = np.round((df_stock_tmp[<span class="string">'close'</span>] - df_stock_tmp[<span class="string">'close'</span>].shift(<span class="number">1</span>)) / df_stock_tmp[<span class="string">'close'</span>].shift(<span class="number">1</span>), <span class="number">4</span>)</div><div class="line">        df_stock_tmp[<span class="string">'code'</span>] = code</div><div class="line">        print(<span class="string">'Collected data '</span> + code +</div><div class="line">              <span class="string">' COUNT:'</span> + str(len(df_stock_tmp.index)))</div><div class="line">        <span class="keyword">return</span> df_stock_tmp</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    session, engine = connection()</div><div class="line">    create_database(session)</div><div class="line">    get_all_stock_name(session, engine)</div><div class="line">    stock_list_code = ts.get_stock_basics().index</div><div class="line">    stock_count = len(stock_list_code)</div><div class="line">    df_stock = pd.DataFrame()</div><div class="line"></div><div class="line">    myQueue = Queue()</div><div class="line">    <span class="keyword">for</span> code <span class="keyword">in</span> stock_list_code:</div><div class="line">        myQueue.put(code)</div><div class="line">    queue = Queue()</div><div class="line"></div><div class="line">    threads = []</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</div><div class="line">        threads.append(Get_stock_basics_Thread(<span class="string">"thread-"</span> + str(i), queue))</div><div class="line">    threads.append(Write_to_MySQL(<span class="string">'Con.'</span>, queue))</div><div class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</div><div class="line">        t.start()</div><div class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</div><div class="line">        t.join()</div></pre></td></tr></table></figure></p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/02/08/资源比对平台爬虫/" class="prev">PREV</a><a href="/2017/01/17/搞事情-2/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://yoursite.com">BonjourChen</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>